From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Mina Her <minacle@live.com>
Date: Sun, 17 Nov 2024 06:10:55 +0900
Subject: [PATCH] Add colour preview for HEX-like hashtags


diff --git a/app/javascript/mastodon/components/status_content.jsx b/app/javascript/mastodon/components/status_content.jsx
index 0628e0791b..5bbdaed967 100644
--- a/app/javascript/mastodon/components/status_content.jsx
+++ b/app/javascript/mastodon/components/status_content.jsx
@@ -116,6 +116,22 @@ class StatusContent extends PureComponent {
         link.addEventListener('click', this.onHashtagClick.bind(this, link.text), false);
         link.setAttribute('href', `/tags/${link.text.replace(/^#/, '')}`);
         link.setAttribute('data-menu-hashtag', this.props.status.getIn(['account', 'id']));
+        if (/^#(?:[0-9A-F]{3}|[0-9A-F]{6})$/i.test(link.textContent)) {
+          const color = link.textContent;
+          const isColorLight = (() => {
+            const toLinear = (value) => value <= 0.04045 ? value / 12.92 : Math.pow((value + 0.055) / 1.055, 2.4);
+            const luminance =
+              0.2126 * toLinear(parseInt(color.slice(1, 3), 16) / 255) +
+              0.7152 * toLinear(parseInt(color.slice(3, 5), 16) / 255) +
+              0.0722 * toLinear(parseInt(color.slice(5, 7), 16) / 255);
+            return luminance > 0.179;
+          })();
+          const colorSpan = document.createElement('span');
+          colorSpan.style.backgroundColor = color;
+          colorSpan.classList.add('color-box');
+          colorSpan.classList.add(isColorLight ? 'color-box--light' : 'color-box--dark');
+          link.parentElement.insertBefore(colorSpan, link);
+        }
       } else {
         link.setAttribute('title', link.href);
         link.classList.add('unhandled-link');
diff --git a/app/javascript/styles/mastodon/components.scss b/app/javascript/styles/mastodon/components.scss
index 70b0da95be..f00c38705d 100644
--- a/app/javascript/styles/mastodon/components.scss
+++ b/app/javascript/styles/mastodon/components.scss
@@ -1072,6 +1072,18 @@ body > [data-popper-placement] {
   clear: both;
 }
 
+.status__content .color-box {
+  display: inline-block;
+  box-sizing: border-box;
+  width: 0.75em;
+  height: 0.75em;
+  margin-inline-end: 0.0625em;
+  border-radius: 50%;
+  border-width: 1px;
+  border-style: solid;
+  border-color: $ui-secondary-color;
+}
+
 .status__content,
 .edit-indicator__content,
 .reply-indicator__content {
